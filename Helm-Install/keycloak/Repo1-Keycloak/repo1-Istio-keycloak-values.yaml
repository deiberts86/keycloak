# Additional Pod annotations
podAnnotations:
  proxy.istio.io/config: '{ "holdApplicationUntilProxyStarts": true }'
  sidecar.istio.io/rewriteAppHTTPProbers: "true"
# Pod Labels for Keycloak
podLabels:
  app: keycloak
  version: v1
#
command:
  - "/opt/keycloak/bin/kc.sh"
#
args:
  - "start"
#
extraEnv: |-
  - name: KC_HEALTH_ENABLED
    value: "true"
  - name: KEYCLOAK_PRODUCTION
    value: "true"
  - name: KC_PROXY
    value: "edge"
  - name: KC_HTTP_RELATIVE_PATH
    value: "/auth"
  - name: KC_CACHE
    value: "ispn"
  - name: KC_CACHE_STACK
    value: "kubernetes"
  - name: KC_HTTP_ENABLED
    value: "false"
  - name: KC_HOSTNAME
    value: "keycloak.domain.com"
  - name: KC_HOSTNAME_STRICT
    value: "true"
  - name: KC_HOSTNAME_STRICT_HTTPS
    value: "true"
  - name: QUARKUS_TRANSACTION_MANAGER_ENABLE_RECOVERY
    value: "true"
  - name: JAVA_OPTS_APPEND
    value: "-Djgroups.dns.query=keycloak-headless"
  - name: KC_LOG_LEVEL
    value: "org.keycloak.events:DEBUG,org.infinispan:INFO,org.jgroups:INFO"
# - name: DB_VENDOR
#   value: postgres
# - name: DB_ADDR
#   value: "postgresql.keycloak.svc.cluster.local"
# - name: DB_PORT
#   value: "5432"
# - name: DB_DATABASE
#   value: postgres
# - name: DB_USER
#   value: postgres
# - name: DB_PASSWORD
#   value: postgres
# - name: KEYCLOAK_ADMIN
#   value: "admin"
# - name: KEYCLOAK_ADMIN_PASSWORD
#   value: ""
# name: DB_USER_FILE
# value: "/secrets/name/user"
# name: DB_PASSWORD_FILE
# value: "/secrets/name/password"
#
# extraVolumeMounts: |
#   - name: name
#     mountPath: /secrets/name
#     readOnly: true
# extraVolumes: |
#   - name: name
#     secret:
#       secretName: secret-name
#
replicas: 1
#
image:
  repository: registry1.dso.mil/ironbank/opensource/keycloak/keycloak
  tag: "21.1.1"
  pullPolicy: Always
#
imagePullSecrets:
- name: registry1-secret
#
updateStrategy: RollingUpdate
#
podSecurityContext:
  fsGroup: 1000
  runAsNonRoot: true
securityContext:
  runAsUser: 1000
  runAsNonRoot: true
  capabilities:
    drop:
      - ALL
#
resources:
  requests:
    cpu: "500m"
    memory: "1Gi"
  limits:
    cpu: "1"
    memory: "1Gi"
#
## Network policy configuration
networkPolicy:
  # If true, the Network policies are deployed
  enabled: false

pgchecker:
  image:
    # Docker image used to check Postgresql readiness at startup
    repository: registry1.dso.mil/ironbank/opensource/postgres/postgresql12
    # Image tag for the pgchecker image
    tag: 12.15
    # Image pull policy for the pgchecker image
    pullPolicy: Always
  # SecurityContext for the pgchecker container
  securityContext:
    allowPrivilegeEscalation: false
    runAsUser: 1337
    runAsGroup: 1337
    runAsNonRoot: true
    capabilities:
      drop:
        - ALL
  # Resource requests and limits for the pgchecker container
  resources:
    requests:
      cpu: "20m"
      memory: "32Mi"
    limits:
      cpu: "20m"
      memory: "32Mi"
#
autoscaling:
  # If `true`, an autoscaling/v2beta2 HorizontalPodAutoscaler resource is created (requires Kubernetes 1.18 or above)
  # Autoscaling seems to be most reliable when using KUBE_PING service discovery (see README for details)
  # This disables the `replicas` field in the StatefulSet
  enabled: false
  # Additional HorizontalPodAutoscaler labels
  labels: {}
  # The minimum and maximum number of replicas for the Keycloak StatefulSet
  minReplicas: 3
  maxReplicas: 10
  # The metrics to use for scaling
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 80
  # The scaling policy to use. This will scale up quickly but only scale down a single Pod per 5 minutes.
  # This is important because caches are usually only replicated to 2 Pods and if one of those Pods is terminated this will give the cluster time to recover.
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Pods
          value: 1
          periodSeconds: 300
#
postgresql:
  # If `true`, the Postgresql dependency is enabled
  enabled: true
  # PostgreSQL User to create
  postgresqlUsername: keycloak
  # PostgreSQL Password for the new user
  postgresqlPassword: keycloak
  # PostgreSQL Database to create
  postgresqlDatabase: keycloak
  # PostgreSQL network policy configuration
  networkPolicy:
    enabled: false
  # Added by BigBang
  # change bitnami sub-chart upstream image to pull from registry1.dso.mil
  # this image is only used for dev and CI pipelines
  global:
    imagePullSecrets:
      - registry1-secret
  image:
    registry: registry1.dso.mil
    repository: ironbank/opensource/postgres/postgresql12
    tag: 12.15
  securityContext:
    enabled: true
    fsGroup: 26
    runAsUser: 1001
    runAsGroup: 1001
  containerSecurityContext:
    enabled: true
    runAsUser: 26
    capabilities:
      drop:
        - ALL
#
secrets:
  env:
    stringData:
      # https://access.redhat.com/documentation/en-us/openjdk/11/html-single/configuring_openjdk_11_on_rhel_with_fips/index
      JAVA_TOOL_OPTIONS: "-Dcom.redhat.fips=true"
      # default admin credentials. Override them for production deployments
      KEYCLOAK_ADMIN: "admin"
      KEYCLOAK_ADMIN_PASSWORD: "password12345"
#
ingress:
  enabled: false